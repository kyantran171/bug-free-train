!function(e){function t(i){if(r[i])return r[i].exports;var o=r[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t){if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");AFRAME.registerComponent("environment",{schema:{active:{default:!1},preset:{default:"default",oneOf:["none","default","contact","egypt","checkerboard","forest","goaland","yavapai","goldmine","arches","threetowers","poison","tron","japan","dream","volcano","starry","osiris"]},seed:{type:"int",default:1,min:0,max:1e3},skyType:{default:"color",oneOf:["none","color","gradient","atmosphere"]},skyColor:{type:"color"},horizonColor:{type:"color"},lighting:{default:"distant",oneOf:["none","distant","point"]},shadow:{default:!1},shadowSize:{default:10},lightPosition:{type:"vec3",default:{x:0,y:1,z:-.2}},fog:{type:"float",default:0,min:0,max:1},flatShading:{default:!1},playArea:{type:"float",default:1,min:.5,max:10},ground:{default:"hills",oneOf:["none","flat","hills","canyon","spikes","noise"]},groundYScale:{type:"float",default:3,min:0,max:50},groundTexture:{default:"none",oneOf:["none","checkerboard","squares","walkernoise"]},groundColor:{type:"color",default:"#553e35"},groundColor2:{type:"color",default:"#694439"},dressing:{default:"none",oneOf:["none","cubes","pyramids","cylinders","hexagons","stones","trees","mushrooms","towers","apparatus","arches","torii"]},dressingAmount:{type:"int",default:10,min:0,max:1e3},dressingColor:{type:"color",default:"#795449"},dressingScale:{type:"float",default:5,min:0,max:100},dressingVariance:{type:"vec3",default:{x:1,y:1,z:1}},dressingUniformScale:{default:!0},dressingOnPlayArea:{type:"float",default:0,min:0,max:1},grid:{default:"none",oneOf:["none","1x1","2x2","crosses","dots","xlines","ylines"]},gridColor:{type:"color",default:"#ccc"}},multiple:!1,presets:{none:{},default:{active:!0,seed:1,skyType:"atmosphere",skyColor:"#88c",horizonColor:"#ddd",lighting:"distant",lightPosition:{x:-.11,y:1,z:.33},fog:.78,flatShading:!1,playArea:1,ground:"noise",groundYScale:1,groundTexture:"checkerboard",groundColor:"#FAD5A5",groundColor2:"#FAD5A5",dressing:"none",dressingAmount:10,dressingColor:"#795449",dressingScale:1,dressingVariance:{x:0,y:0,z:0},dressingUniformScale:!0,dressingOnPlayArea:0,grid:"none",gridColor:"#ccc",shadow:!1},contact:{active:!0,seed:14,skyType:"gradient",skyColor:"#478d54",horizonColor:"#b696cb",lighting:"distant",lightPosition:{x:0,y:2.01,z:-1},fog:.8,flatShading:!1,playArea:1,ground:"spikes",groundYScale:4.91,groundTexture:"none",groundColor:"#FAD5A5",groundColor2:"#FAD5A5",dressing:"apparatus",dressingAmount:7,dressingColor:"#657067",dressingScale:20,dressingVariance:{x:20,y:20,z:20},dressingUniformScale:!0,dressingOnPlayArea:0,grid:"1x1",gridColor:"#478d54",shadow:!1},egypt:{active:!0,seed:26,skyType:"gradient",skyColor:"#1b7660",horizonColor:"#e4b676",lighting:"distant",lightPosition:{x:0,y:1.65,z:-1},fog:.75,flatShading:!1,playArea:1,ground:"hills",groundYScale:5,groundTexture:"walkernoise",groundColor:"#FAD5A5",groundColor2:"#FAD5A5",dressing:"pyramids",dressingAmount:10,dressingColor:"#7c5c45",dressingScale:5,dressingVariance:{x:20,y:20,z:20},dressingUniformScale:!0,dressingOnPlayArea:0,grid:"spots",gridColor:"#e4b676",shadow:!1},checkerboard:{active:!0,seed:1,skyType:"gradient",skyColor:"#0d0d0d",horizonColor:"#404040",lighting:"distant",lightPosition:{x:0,y:1,z:-.2},fog:.81,flatShading:!0,playArea:1,ground:"hills",groundYScale:4.81,groundTexture:"checkerboard",groundColor:"#FAD5A5",groundColor2:"#FAD5A5",dressing:"cubes",dressingAmount:10,dressingColor:"#9f9f9f",dressingScale:1.51,dressingVariance:{x:5,y:20,z:5},dressingUniformScale:!0,dressingOnPlayArea:0,grid:"dots",gridColor:"#ccc",shadow:!1},forest:{active:!0,seed:8,skyType:"gradient",skyColor:"#24b59f",horizonColor:"#eff9b7",lighting:"distant",lightPosition:{x:-1.2,y:.88,z:-.55},fog:.8,flatShading:!1,playArea:1,ground:"noise",groundYScale:4.18,groundTexture:"squares",groundColor:"#937a24",groundColor2:"#987d2e",dressing:"trees",dressingAmount:500,dressingColor:"#888b1d",dressingScale:1,dressingVariance:{x:10,y:10,z:10},dressingUniformScale:!0,dressingOnPlayArea:0,grid:"none",gridColor:"#c5a543",shadow:!1},goaland:{active:!0,seed:17,skyType:"gradient",skyColor:"#14645f",horizonColor:"#a3dab8",lighting:"point",lightPosition:{x:.1,y:4,z:.56},fog:.73,flatShading:!1,playArea:1,ground:"noise",groundYScale:.81,groundTexture:"none",groundColor:"#ae3241",groundColor2:"#db4453",dressing:"mushrooms",dressingAmount:150,dressingColor:"#a9313d",dressingScale:5,dressingVariance:{x:5,y:10,z:5},dressingUniformScale:!0,dressingOnPlayArea:0,grid:"dots",gridColor:"#239893",shadow:!1},yavapai:{active:!0,seed:11,skyType:"gradient",skyColor:"#239849",horizonColor:"#cfe0af",lighting:"distant",lightPosition:{x:.5,y:1,z:0},fog:.8,flatShading:!0,playArea:1,ground:"canyon",groundYScale:9.76,groundTexture:"walkernoise",groundColor:"#C66344",groundColor2:"#c96b4b",dressing:"stones",dressingAmount:500,dressingColor:"#C66344",dressingScale:.06,dressingVariance:{x:.2,y:.1,z:.2},dressingUniformScale:!0,dressingOnPlayArea:1,grid:"none",gridColor:"#239893",shadow:!1},goldmine:{active:!0,seed:53,skyType:"gradient",skyColor:"#1e1c1a",horizonColor:"#8c7964",lighting:"point",lightPosition:{x:-.09,y:3,z:.33},fog:.43,flatShading:!0,playArea:1.08,ground:"canyon",groundYScale:50,groundTexture:"none",groundColor:"#353535",groundColor2:"#454545",dressing:"hexagons",dressingAmount:300,dressingColor:"#fe921b",dressingScale:.5,dressingVariance:{x:2,y:8,z:2},dressingUniformScale:!0,dressingOnPlayArea:.03,grid:"none",gridColor:"#ccc",shadow:!1},threetowers:{active:!0,seed:5,skyType:"gradient",skyColor:"#23a06b",horizonColor:"#f5e170",lighting:"distant",lightPosition:{x:.5,y:1,z:0},fog:.8,flatShading:!1,playArea:1,ground:"spikes",groundYScale:4.26,groundTexture:"walkernoise",groundColor:"#273a49",groundColor2:"#2b464f",dressing:"towers",dressingAmount:3,dressingColor:"#5f6d94",dressingScale:50,dressingVariance:{x:10,y:100,z:10},dressingUniformScale:!0,dressingOnPlayArea:0,grid:"none",gridColor:"#239893",shadow:!1},poison:{active:!0,seed:92,skyType:"gradient",skyColor:"#1ea84a",horizonColor:"#177132",lighting:"distant",lightPosition:{x:.5,y:1,z:0},fog:.8,flatShading:!1,playArea:1,ground:"canyon",groundYScale:9.76,groundTexture:"none",groundColor:"#851f31",groundColor2:"#912235",dressing:"hexagons",dressingAmount:20,dressingColor:"#c7415b",dressingScale:20,dressingVariance:{x:20,y:200,z:20},dressingUniformScale:!1,dressingOnPlayArea:0,grid:"crosses",gridColor:"#1ea84a",shadow:!1},arches:{active:!0,seed:19,skyType:"atmosphere",skyColor:"#8cbdc8",horizonColor:"#ddd",lighting:"distant",lightPosition:{x:-.11,y:.16,z:.33},fog:.67,flatShading:!0,playArea:1,ground:"canyon",groundYScale:10,groundTexture:"walkernoise",groundColor:"#a87d6f",groundColor2:"#795449",dressing:"arches",dressingAmount:6,dressingColor:"#795449",dressingScale:26,dressingVariance:{x:20,y:40,z:20},dressingUniformScale:!0,dressingOnPlayArea:.04,grid:"none",gridColor:"#ccc",shadow:!1},tron:{active:!0,seed:14,skyType:"gradient",skyColor:"#091b39",horizonColor:"#284a9e",lighting:"distant",lightPosition:{x:-.72,y:.62,z:.4},fog:.8,flatShading:!1,playArea:1,ground:"spikes",groundYScale:4.91,groundTexture:"none",groundColor:"#061123",groundColor2:"#694439",dressing:"towers",dressingAmount:5,dressingColor:"#fb000e",dressingScale:15,dressingVariance:{x:20,y:20,z:20},dressingUniformScale:!0,dressingOnPlayArea:0,grid:"1x1",gridColor:"#fb000e",shadow:!1},japan:{active:!0,seed:14,skyType:"gradient",skyColor:"#7e5db5",horizonColor:"#b4adda",lighting:"distant",lightPosition:{x:1.33,y:1,z:.24},fog:.9,flatShading:!1,playArea:1,ground:"hills",groundYScale:25,groundTexture:"walkernoise",groundColor:"#7e5db5",groundColor2:"#cabdf5",dressing:"torii",dressingAmount:4,dressingColor:"#bc5e7c",dressingScale:15,dressingVariance:{x:0,y:0,z:0},dressingUniformScale:!0,dressingOnPlayArea:0,grid:"spots",gridColor:"#e4b676",shadow:!1},dream:{active:!0,seed:17,skyType:"gradient",skyColor:"#87faf4",horizonColor:"#b34093",lighting:"distant",lightPosition:{x:-.72,y:.53,z:.97},fog:.8,flatShading:!1,playArea:1,ground:"hills",groundYScale:20,groundTexture:"checkerboard",groundColor:"#b34093",groundColor2:"#c050a2",dressing:"mushrooms",dressingAmount:300,dressingColor:"#3cf7ed",dressingScale:.2,dressingVariance:{x:.2,y:.2,z:.2},dressingUniformScale:!0,dressingOnPlayArea:1,grid:"none",gridColor:"#239893",shadow:!1},volcano:{active:!0,seed:92,skyType:"gradient",skyColor:"#4a070f",horizonColor:"#f62300",lighting:"point",lightPosition:{x:.5,y:2.25,z:0},fog:.87,flatShading:!1,playArea:1,ground:"canyon",groundYScale:9.76,groundTexture:"walkernoise",groundColor:"#fb0803",groundColor2:"#510000",dressing:"arches",dressingAmount:15,dressingColor:"#fb0803",dressingScale:3,dressingVariance:{x:10,y:100,z:10},dressingUniformScale:!1,dressingOnPlayArea:.2,grid:"none",gridColor:"#fa0e00",shadow:!1},starry:{active:!0,seed:1,skyType:"atmosphere",skyColor:"#88c",horizonColor:"#ddd",lighting:"distant",lightPosition:{x:0,y:-.01,z:-.46},fog:.7,flatShading:!1,playArea:1,ground:"hills",groundYScale:3,groundTexture:"none",groundColor:"#553e35",groundColor2:"#694439",dressing:"none",dressingAmount:100,dressingColor:"#795449",dressingScale:5,dressingVariance:{x:1,y:1,z:1},dressingUniformScale:!0,grid:"1x1",dressingOnPlayArea:0,gridColor:"#39d2f2",shadow:!1},osiris:{active:!0,seed:46,skyType:"atmosphere",skyColor:"#88c",horizonColor:"#ddd",lighting:"distant",lightPosition:{x:0,y:.02,z:-.46},fog:0,flatShading:!1,playArea:1,ground:"hills",groundYScale:3,groundTexture:"none",groundColor:"#9e7b47",groundColor2:"#9e7b47",dressing:"pyramids",dressingAmount:7,dressingColor:"#9e7b47",dressingScale:5,dressingVariance:{x:1,y:1,z:1},dressingUniformScale:!0,grid:"dots",dressingOnPlayArea:0,gridColor:"#daa452",shadow:!1},moon:{active:!0,seed:11,skyType:"gradient",skyColor:"#000000",horizonColor:"#000000",lighting:"distant",lightPosition:{x:.5,y:1,z:0},fog:.8,flatShading:!0,playArea:1,ground:"canyon",groundYScale:9.76,groundTexture:"walkernoise",groundColor:"#D1D1D1",groundColor2:"#494949",dressing:"stones",dressingAmount:500,dressingColor:"#494949",dressingScale:.06,dressingVariance:{x:.2,y:.1,z:.2},dressingUniformScale:!0,dressingOnPlayArea:1,grid:"none",gridColor:"#239893",shadow:!1}},init:function(){this.environmentData={},this.STAGE_SIZE=200,this.assets={arches:[{type:"mesh",vertices:[0]}],towers:[{type:"extrude",vertices:[-.054,-.178,-.007,-.182,.069,-.027,.189,.079,.178,.124,-.007,.097,-.145,.182,-.178,.144,-.079,-.021]},{type:"lathe",segments:4,vertices:[.004,.02,.012,.092,.042,.166,.067,.55,.101,.594,.105,.838,.193,.934,.18,.994]},{type:"lathe",segments:5,vertices:[0]}],trees:[{type:"lathe",noise:.015,segments:6,vertices:[0]},{type:"lathe",noise:.02,segments:10,vertices:[1e-6,.562,.091,.572,.172,.61,.223,.666,.256,.74,.258,.806,.246,.824,.062,.826,.065,.948,.097,.998]},{type:"lathe",noise:.02,segments:10,vertices:[1e-6,.768,.099,.772,.219,.802,.306,.844,.352,.886,.352,.908,.118,.904,.107,.93,.115,.966,.14,.996]}]};for(var e in this.assets)for(var t=0;t<this.assets[e].length;t++){var r=this.assets[e][t];if("mesh"==r.type)for(var i=0,o=r.vertices.length;i<o;i++)r.vertices[i]/=1e3}this.userFog=this.el.sceneEl.getAttribute("fog"),this.sky=document.createElement("a-sky"),this.sky.setAttribute("radius",this.STAGE_SIZE),this.sky.setAttribute("theta-length",110),this.sky.classList.add("environment"),this.stars=null,this.groundMaterial=null,this.ground=document.createElement("a-entity"),this.ground.setAttribute("rotation","-90 0 0"),this.ground.classList.add("environmentGround"),this.ground.classList.add("environment"),this.groundCanvas=null,this.groundTexture=null,this.groundMaterial=null,this.groundGeometry=null,this.dressing=document.createElement("a-entity"),this.dressing.classList.add("environmentDressing"),this.dressing.classList.add("environment"),this.gridCanvas=null,this.gridTexture=null,this.hemilight=document.createElement("a-entity"),this.hemilight.classList.add("environment"),this.hemilight.setAttribute("position","0 50 0"),this.hemilight.setAttribute("light",{type:"hemisphere",color:"#CEE4F0",intensity:.4}),this.sunlight=document.createElement("a-entity"),this.sunlight.classList.add("environment"),this.sunlight.setAttribute("position",this.data.lightPosition),this.sunlight.setAttribute("light",{intensity:.6}),this.el.appendChild(this.hemilight),this.el.appendChild(this.sunlight),this.el.appendChild(this.ground),this.el.appendChild(this.dressing),this.el.appendChild(this.sky)},getFogColor:function(e,t){var r;if("color"==e||"none"==e)r=new THREE.Color(this.environmentData.skyColor);else if("gradient"==e)r=new THREE.Color(this.environmentData.horizonColor);else if("atmosphere"==e){var i=[1,.5,.22,.1,.05,0],o=["#C0CDCF","#81ADC5","#525e62","#2a2d2d","#141616","#000"];if(t<=0)return"#000";t=Math.min(1,t);for(var n=0;n<i.length;n++)if(t>i[n]){var s=new THREE.Color(o[n-1]),a=new THREE.Color(o[n]),l=(t-i[n])/(i[n-1]-i[n]);a.lerp(s,l),r=a;break}}return r.multiplyScalar(.9),r.lerp(new THREE.Color(this.data.groundColor),.3),"#"+r.getHexString()},update:function(e){var t;this.data.preset?(t=AFRAME.utils.clone(this.environmentData),this.environmentData={},Object.assign(this.environmentData,this.data),Object.assign(this.environmentData,this.presets[this.data.preset]),Object.assign(this.environmentData,this.el.components.environment.attrValue),console.log(this.environmentData)):(t=e,this.environmentData=this.data);var r=this.environmentData.skyType,i=new THREE.Vector3(this.environmentData.lightPosition.x,this.environmentData.lightPosition.y,this.environmentData.lightPosition.z);if(i.normalize(),this.sunlight){if(this.sunlight.setAttribute("position",this.environmentData.lightPosition),"atmosphere"!=r){var o=new THREE.Color(this.environmentData.skyColor);o.r=(o.r+1)/2,o.g=(o.g+1)/2,o.b=(o.b+1)/2,this.hemilight.setAttribute("light",{color:"#"+o.getHexString()}),this.sunlight.setAttribute("light",{intensity:.6}),this.hemilight.setAttribute("light",{intensity:.6})}else this.sunlight.setAttribute("light",{intensity:.1+.5*i.y}),this.hemilight.setAttribute("light",{intensity:.1+.5*i.y});this.sunlight.setAttribute("light",{castShadow:this.environmentData.shadow,shadowCameraLeft:-this.environmentData.shadowSize,shadowCameraBottom:-this.environmentData.shadowSize,shadowCameraRight:this.environmentData.shadowSize,shadowCameraTop:this.environmentData.shadowSize})}if(r!==t.skyType||this.environmentData.skyColor!=t.skyColor||this.environmentData.horizonColor!=t.horizonColor){var n={};n.shader={none:"flat",color:"flat",gradient:"gradientshader",atmosphere:"skyshader"}[r],this.stars&&this.stars.setAttribute("visible","atmosphere"==r),"color"==r?(n.color=this.environmentData.skyColor,n.fog=!1):"gradient"==r&&(n.topColor=this.environmentData.skyColor,n.bottomColor=this.environmentData.horizonColor),this.sky.setAttribute("material",n)}"atmosphere"==r&&(this.sky.setAttribute("material",{sunPosition:i}),this.setStars(2e3*(1-Math.max(0,8*(i.y+.08))))),this.environmentData.fog>0?this.el.sceneEl.setAttribute("fog",{color:this.getFogColor(r,i.y),far:(1.01-this.environmentData.fog)*this.STAGE_SIZE*2}):this.el.sceneEl.removeAttribute("fog"),this.sunlight.setAttribute("light",{type:"point"==this.environmentData.lighting?"point":"directional"}),this.sunlight.setAttribute("visible","none"!==this.environmentData.lighting),this.hemilight.setAttribute("visible","none"!==this.environmentData.lighting);var s=!this.groundGeometry||this.environmentData.seed!=t.seed||this.environmentData.ground!=t.ground||this.environmentData.playArea!=t.playArea||this.environmentData.flatShading!=t.flatShading;(s||this.environmentData.groundColor!=t.groundColor||this.environmentData.groundColor2!=t.groundColor2||this.environmentData.groundYScale!=t.groundYScale||this.environmentData.groundTexture!=t.groundTexture||this.environmentData.gridColor!=t.gridColor||this.environmentData.grid!=t.grid)&&(this.updateGround(s),this.hemilight&&this.hemilight.setAttribute("light",{groundColor:this.environmentData.groundColor})),this.environmentData.seed==t.seed&&this.environmentData.dressingOnPlayArea==t.dressingOnPlayArea&&this.environmentData.dressing==t.dressing&&this.environmentData.flatShading==t.flatShading&&this.environmentData.dressingAmount==t.dressingAmount&&this.environmentData.dressingScale==t.dressingScale&&this.environmentData.dressingColor==t.dressingColor&&this.environmentData.dressingVariance.x==t.dressingVariance.x&&this.environmentData.dressingVariance.y==t.dressingVariance.y&&this.environmentData.dressingVariance.z==t.dressingVariance.z&&this.environmentData.dressingUniformScale==t.dressingUniformScale||this.updateDressing(),this.sky.setAttribute("visible","none"!==r),this.el.setAttribute("visible",this.environmentData.active),this.environmentData.active||(this.userFog?this.el.sceneEl.setAttribute("fog",this.userFog):this.el.sceneEl.removeAttribute("fog")),this.dumpParametersDiff()},logPreset:function(){var e="{";for(var t in this.schema)if("preset"!=t){e+=t+": ";var r=this.schema[t].type;e+="vec3"==r?"{ x: "+this.environmentData[t].x+", y: "+this.environmentData[t].y+", z: "+this.environmentData[t].z+"}":"string"==r||"color"==r?'"'+this.environmentData[t]+'"':this.environmentData[t],e+=", "}e+="}",console.log(e)},dumpParametersDiff:function(){function e(e){return Math.floor(1e3*e)/1e3}var t=[],r="none"!=this.data.preset&&this.presets[this.data.preset];r&&t.push("preset: "+this.data.preset);for(var i in this.schema)if(!("preset"==i||r&&void 0===r[i])){var o=r?r[i]:this.schema[i].default,n=this.environmentData[i],s=this.schema[i].type;if("vec3"==s){var a=o;"string"==typeof o&&(o=o.split(" "),a={x:o[0],y:o[1],z:o[2]}),e(a.x)==e(n.x)&&e(a.y)==e(n.y)&&e(a.z)==e(n.z)||t.push(i+": "+e(n.x)+" "+e(n.y)+" "+e(n.z))}else o!=n&&("number"==this.schema[i].type&&(n=e(n)),t.push(i+": "+n))}console.log("%c"+t.join("; "),"color: #f48;font-weight:bold")},random:function(e){return parseFloat("0."+Math.sin(9999*this.environmentData.seed*e).toString().substr(7))},updateGround:function(e){var t=64;if(e){var i="none"!=this.environmentData.ground;if(this.ground.setAttribute("visible",i),!i)return;this.groundGeometry||(this.groundGeometry=new THREE.PlaneGeometry(this.STAGE_SIZE+2,this.STAGE_SIZE+2,t-1,t-1));for(var o=new r(this.environmentData.seed),n=this.groundGeometry.attributes.position.array,s=n.length,a=10,l=a/t,d=0,h=0,g=2;g<s;g+=3)if("flat"!=this.environmentData.ground){var c;switch(this.environmentData.ground){case"hills":c=Math.max(0,o.noise(d,h,0));break;case"canyon":c=.2+.8*o.noise(d,h,0),c=Math.min(1,10*Math.pow(c,2));break;case"spikes":c=this.random(g)<.02?this.random(g+1):0;break;case"noise":c=this.random(g)<.35?this.random(g+1):0}c+=.1*this.random(g+2);var u=2*d/a-1,m=2*h/a-1,f=this.environmentData.playArea;u=Math.max(0,Math.min(1,(Math.abs(u)-(f-.9))*(1/f))),m=Math.max(0,Math.min(1,(Math.abs(m)-(f-.9))*(1/f))),c*=u>m?u:m,c<.01&&(c=0),n[g]=c,d+=l,d>=10&&(d=0,h+=l)}else n[g]=0;this.groundGeometry.computeVertexNormals(),this.groundGeometry.attributes.position.needsUpdate=!0,this.groundGeometry.attributes.normal.needsUpdate=!0}this.ground.setAttribute("scale",{z:this.environmentData.groundYScale});var p=2048,y=20,v=this.STAGE_SIZE/y;this.groundCanvas&&this.groundCanvas.width==p||(this.gridCanvas=document.createElement("canvas"),this.gridCanvas.width=p,this.gridCanvas.height=p,this.gridTexture=new THREE.Texture(this.gridCanvas),this.gridTexture.wrapS=THREE.RepeatWrapping,
this.gridTexture.wrapT=THREE.RepeatWrapping,this.gridTexture.repeat.set(v,v),this.groundCanvas=document.createElement("canvas"),this.groundCanvas.width=p,this.groundCanvas.height=p,this.groundTexture=new THREE.Texture(this.groundCanvas),this.groundTexture.wrapS=THREE.RepeatWrapping,this.groundTexture.wrapT=THREE.RepeatWrapping,this.groundTexture.repeat.set(v,v),this.groundMaterialProps={map:this.groundTexture,emissive:new THREE.Color(16777215),emissiveMap:this.gridTexture},(new THREE.Material).hasOwnProperty("shading")?this.groundMaterialProps.shading=this.environmentData.flatShading?THREE.FlatShading:THREE.SmoothShading:this.groundMaterialProps.flatShading=this.environmentData.flatShading,this.groundMaterial=new THREE.MeshLambertMaterial(this.groundMaterialProps));var C=this.groundCanvas.getContext("2d"),x=this.gridCanvas.getContext("2d");if(this.drawTexture(C,p,y),x.fillStyle="#000000",x.fillRect(0,0,p,p),this.drawGrid(x,p,y),this.groundTexture.needsUpdate=!0,this.gridTexture.needsUpdate=!0,e){var E=new THREE.Mesh(this.groundGeometry,this.groundMaterial);this.ground.setObject3D("mesh",E)}else this.ground.getObject3D("mesh").material=this.groundMaterial;this.ground.setAttribute("shadow",{cast:!1,receive:this.environmentData.shadow})},drawGrid:function(e,t,r){if("none"!=this.environmentData.grid){var i,o,n,s=Math.floor(r/2),a=t/(r/2);switch(e.fillStyle=this.environmentData.gridColor,this.environmentData.grid){case"1x1":case"2x2":for("1x1"==this.environmentData.grid&&(s*=2,a=t/r),i=0;i<s;i++)n=Math.floor(i*a),e.fillRect(0,n,t,1),e.fillRect(n,0,1,t);break;case"crosses":var l=Math.floor(a/20);for(i=0;i<s+1;i++)for(n=Math.floor(i*a),o=0;o<s+1;o++){var d=Math.floor(-l+o*a);e.fillRect(d,n,2*l,1),e.fillRect(n,d,1,2*l)}break;case"dots":for(i=0;i<s+1;i++)for(o=0;o<s+1;o++)e.beginPath(),e.arc(Math.floor(o*a),Math.floor(i*a),4,0,2*Math.PI),e.fill();break;case"xlines":for(i=0;i<s;i++)e.fillRect(Math.floor(i*a),0,1,t);break;case"ylines":for(i=0;i<s;i++)e.fillRect(0,Math.floor(i*a),t,1)}}},drawTexture:function(e,t,i){e.fillStyle=this.environmentData.groundColor,e.fillRect(0,0,t,t);var o,n,s,a,l,d,h;if("none"!=this.environmentData.groundTexture)switch(this.environmentData.groundTexture){case"checkerboard":e.fillStyle=this.environmentData.groundColor2;var g=Math.floor(i/2),c=t/(i/2);for(o=0;o<g+1;o+=2)for(var u=0;u<g+1;u++)e.fillRect(Math.floor((o+u%2)*c),Math.floor(u*c),Math.floor(c),Math.floor(c));break;case"squares":var m=16,f=t/m;for(s=new THREE.Color(this.environmentData.groundColor),a=new THREE.Color(this.environmentData.groundColor2),o=0;o<m*m;o++)n=this.random(o+3)>.5?s.clone():a.clone(),n.addScalar(.1*this.random(o+3)-.05),e.fillStyle="#"+n.getHexString(),e.fillRect(o%m*f,Math.floor(o/m)*f,f,f);break;case"noise":d=e.getImageData(0,0,t,t),l=d.data,s=new THREE.Color(this.environmentData.groundColor),a=new THREE.Color(this.environmentData.groundColor2);var p=new THREE.Color(a.r-s.r,a.g-s.g,a.b-s.b),y=new r;for(o=0,u=0,h=l.length;o<h;o+=4,u++){var v=y.noise(u%t/t*3,u/t/t*3,0);l[o+0]=Math.floor(255*(s.r+p.r*v)),l[o+1]=Math.floor(255*(s.g+p.g*v)),l[o+2]=Math.floor(255*(s.b+p.b*v))}e.putImageData(d,0,0);break;case"walkernoise":var C=Math.floor(t/2),x=document.createElement("canvas");x.width=C,x.height=C;var E=x.getContext("2d");E.fillStyle=this.environmentData.groundColor,E.fillRect(0,0,C,C),d=E.getImageData(0,0,C,C),l=d.data,s=new THREE.Color(this.environmentData.groundColor),a=new THREE.Color(this.environmentData.groundColor2);var b=[],T=1e3;for(o=0;o<T;o++)n=s.clone().lerp(a,Math.random()),b.push({x:Math.random()*C,y:Math.random()*C,r:Math.floor(255*n.r),g:Math.floor(255*n.g),b:Math.floor(255*n.b)});for(var w=5e3,S=0;S<w;S++)for(o=0;o<T;o++){var A=b[o],D=4*Math.floor(A.y*C+A.x);l[D+0]=A.r,l[D+1]=A.g,l[D+2]=A.b,A.x+=Math.floor(3*Math.random())-1,A.y+=Math.floor(3*Math.random())-1,A.x>=C&&(A.x=A.x-C),A.y>=C&&(A.y=A.y-C),A.x<0&&(A.x=C+A.x),A.y<0&&(A.y=C+A.y)}E.putImageData(d,0,0),e.drawImage(x,0,0,t,t)}},getAssetGeometry:function(e){function t(e,t){for(var r=(new THREE.Vector3,e.attributes.position.array),i=r.length,o=0;o<i;o+=3)r[o]=(s.random(o)-.5)*t,r[o+1]=(s.random(o+i)-.5)*t,r[o+2]=(s.random(o+2*i)-.5)*t;e.attributes.position.needsUpdate=!0}if(!e)return null;for(var r,i,o,n=[],s=this,a=0;a<e.length;a++)if("lathe"==e[a].type){var l=-99999,d=[];for(o=e[a].vertices,r=0;r<o.length;r+=2)d.push(new THREE.Vector2(o[r],o[r+1])),o[r+1]>l&&(l=o[r+1]);i=new THREE.LatheGeometry(d,e[a].segments||8),i.applyMatrix4((new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(-Math.PI,0,0))),i.applyMatrix4((new THREE.Matrix4).makeTranslation(0,l,0)),i=i.toNonIndexed(),n.push(i)}else if("extrude"==e[a].type){var h=new THREE.Shape;for(o=e[a].vertices,r=0;r<o.length;r+=2)0==r?h.moveTo(o[r],o[r+1]):h.lineTo(o[r],o[r+1]);i=new THREE.ExtrudeGeometry(h,{amount:1,bevelEnabled:!1}),i.applyMatrix((new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(-Math.PI/2,0,0))),e[a].noise&&t(i,e[a].noise),n.push(i)}else if("mesh"==e[a].type){i=new THREE.BufferGeometry,o=e[a].vertices;var g=e[a].faces,c=new Float32Array(o);if(i.setIndex(g),i.setAttribute("position",new THREE.BufferAttribute(c,3)),e[a].mirror){var u=i.clone();u.applyMatrix4((new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(0,Math.PI,0))),i=THREE.BufferGeometryUtils.mergeBufferGeometries([i,u])}e[a].noise&&t(i,e[a].noise),i=i.toNonIndexed(),i.computeVertexNormals(),n.push(i)}return n},updateDressing:function(){var e=new THREE.Object3D,t=[];if(this.dressing.setAttribute("visible","none"!=this.environmentData.dressing),"none"!=this.environmentData.dressing){var r;switch(this.environmentData.dressing){case"cubes":r=[new THREE.BoxGeometry(1,1,1)],r[0].applyMatrix((new THREE.Matrix4).makeTranslation(0,.5,0));break;case"pyramids":r=[new THREE.ConeGeometry(1,1,4,1,!0)],r[0].applyMatrix((new THREE.Matrix4).makeTranslation(0,.5,0));break;case"cylinders":r=[new THREE.CylinderGeometry(.5,.5,1,8,1,!0)],r[0].applyMatrix((new THREE.Matrix4).makeTranslation(0,.5,0));break;default:if(r=this.getAssetGeometry(this.assets[this.environmentData.dressing]),!r)return}for(var i=0,o=88343;i<this.environmentData.dressingAmount;i++,o++){var n,s=(r[Math.floor(this.random(33+i)*r.length)].clone,r[Math.floor(this.random(33+i)*r.length)].clone()),a=this.environmentData.dressingScale,l=new THREE.Vector3(this.environmentData.dressingVariance.x,this.environmentData.dressingVariance.y,this.environmentData.dressingVariance.z),d=this.random(o)<this.environmentData.dressingOnPlayArea;n=d?15*this.random(o+1):10+Math.max(l.x,l.z)+10*this.random(o+1)+this.random(o+2)*this.STAGE_SIZE/3;var h=this.random(o+3)*Math.PI*2,g=new THREE.Matrix4,c=this.random(o+4),u=this.environmentData.dressingUniformScale;g.compose(new THREE.Vector3(Math.cos(h)*n,0,Math.sin(h)*n),(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),(this.random(o+5)-.5)*l.length()*Math.PI*2),new THREE.Vector3(a+(u?c:this.random(o+6))*l.x,a+(u?c:this.random(o+7))*l.y,a+(u?c:this.random(o+8))*l.z)),s.applyMatrix4(g),t.push(s)}var m=THREE.BufferGeometryUtils.mergeBufferGeometries(t);m.attributes.position.needsUpdate=!0;var f=new THREE.MeshLambertMaterial({color:new THREE.Color(this.environmentData.dressingColor)}),p=new THREE.Mesh(m,f);e.add(p),this.dressing.setObject3D("mesh",e)}},createStars:function(){for(var e=2e3,t=new THREE.BufferGeometry,r=new Float32Array(3*e),i=this.STAGE_SIZE-1,o=new THREE.Vector3,n=0;n<r.length;n+=3)o.set(this.random(n+23)-.5,this.random(n+24),this.random(n+25)-.5),o.normalize(),o.multiplyScalar(i),r[n]=o.x,r[n+1]=o.y,r[n+2]=o.z;t.setAttribute("position",new THREE.BufferAttribute(r,3)),t.setDrawRange(0,0);var s=new THREE.PointsMaterial({size:.01,color:13421772,fog:!1});this.stars.setObject3D("mesh",new THREE.Points(t,s))},setStars:function(e){this.stars||(this.stars=document.createElement("a-entity"),this.stars.id="stars",this.createStars(),this.el.appendChild(this.stars)),e=Math.floor(Math.min(2e3,Math.max(0,e))),this.stars.getObject3D("mesh").geometry.setDrawRange(0,e)}}),AFRAME.registerShader("skyshader",{schema:{luminance:{type:"number",default:1,min:0,max:2,is:"uniform"},turbidity:{type:"number",default:2,min:0,max:20,is:"uniform"},reileigh:{type:"number",default:1,min:0,max:4,is:"uniform"},mieCoefficient:{type:"number",default:.005,min:0,max:.1,is:"uniform"},mieDirectionalG:{type:"number",default:.8,min:0,max:1,is:"uniform"},sunPosition:{type:"vec3",default:{x:0,y:0,z:-1},is:"uniform"},color:{type:"color",default:"#fff"}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D skySampler;","uniform vec3 sunPosition;","varying vec3 vWorldPosition;","vec3 cameraPos = vec3(0., 0., 0.);","uniform float luminance;","uniform float turbidity;","uniform float reileigh;","uniform float mieCoefficient;","uniform float mieDirectionalG;","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","const float n = 1.0003;","const float N = 2.545E25;","const float pn = 0.035;","const vec3 lambda = vec3(680E-9, 550E-9, 450E-9);","const vec3 K = vec3(0.686, 0.678, 0.666);","const float v = 4.0;","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const vec3 up = vec3(0.0, 1.0, 0.0);","const float EE = 1000.0;","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","const float cutoffAngle = pi/1.95;","const float steepness = 1.5;","vec3 totalRayleigh(vec3 lambda)","{","return (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn));","}","vec3 simplifiedRayleigh()","{","return 0.0005 / vec3(94, 40, 18);","}","float rayleighPhase(float cosTheta)","{   ","return (3.0 / (16.0*pi)) * (1.0 + pow(cosTheta, 2.0));","}","vec3 totalMie(vec3 lambda, vec3 K, float T)","{","float c = (0.2 * T ) * 10E-18;","return 0.434 * c * pi * pow((2.0 * pi) / lambda, vec3(v - 2.0)) * K;","}","float hgPhase(float cosTheta, float g)","{","return (1.0 / (4.0*pi)) * ((1.0 - pow(g, 2.0)) / pow(1.0 - 2.0*g*cosTheta + pow(g, 2.0), 1.5));","}","float sunIntensity(float zenithAngleCos)","{","return EE * max(0.0, 1.0 - exp(-((cutoffAngle - acos(zenithAngleCos))/steepness)));","}","// Filmic ToneMapping http://filmicgames.com/archives/75","float A = 0.15;","float B = 0.50;","float C = 0.10;","float D = 0.20;","float E = 0.02;","float F = 0.30;","float W = 1000.0;","vec3 Uncharted2Tonemap(vec3 x)","{","return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;","}","void main() ","{","float sunfade = 1.0-clamp(1.0-exp((sunPosition.y/450000.0)),0.0,1.0);","float reileighCoefficient = reileigh - (1.0* (1.0-sunfade));","vec3 sunDirection = normalize(sunPosition);","float sunE = sunIntensity(dot(sunDirection, up));","vec3 betaR = simplifiedRayleigh() * reileighCoefficient;","vec3 betaM = totalMie(lambda, K, turbidity) * mieCoefficient;","float zenithAngle = acos(max(0.0, dot(up, normalize(vWorldPosition - cameraPos))));","float sR = rayleighZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","float sM = mieZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","vec3 Fex = exp(-(betaR * sR + betaM * sM));","float cosTheta = dot(normalize(vWorldPosition - cameraPos), sunDirection);","float rPhase = rayleighPhase(cosTheta*0.5+0.5);","vec3 betaRTheta = betaR * rPhase;","float mPhase = hgPhase(cosTheta, mieDirectionalG);","vec3 betaMTheta = betaM * mPhase;","vec3 Lin = pow(sunE * ((betaRTheta + betaMTheta) / (betaR + betaM)) * (1.0 - Fex),vec3(1.5));","Lin *= mix(vec3(1.0),pow(sunE * ((betaRTheta + betaMTheta) / (betaR + betaM)) * Fex,vec3(1.0/2.0)),clamp(pow(1.0-dot(up, sunDirection),5.0),0.0,1.0));","vec3 direction = normalize(vWorldPosition - cameraPos);","float theta = acos(direction.y); // elevation --> y-axis, [-pi/2, pi/2]","float phi = atan(direction.z, direction.x); // azimuth --> x-axis [-pi/2, pi/2]","vec2 uv = vec2(phi, theta) / vec2(2.0*pi, pi) + vec2(0.5, 0.0);","vec3 L0 = vec3(0.1) * Fex;","float sundisk = smoothstep(sunAngularDiameterCos,sunAngularDiameterCos+0.00002,cosTheta);","L0 += (sunE * 19000.0 * Fex)*sundisk;","vec3 whiteScale = 1.0/Uncharted2Tonemap(vec3(W));","vec3 texColor = (Lin+L0);   ","texColor *= 0.04 ;","texColor += vec3(0.0,0.001,0.0025)*0.3;","float g_fMaxLuminance = 1.0;","float fLumScaled = 0.1 / luminance;     ","float fLumCompressed = (fLumScaled * (1.0 + (fLumScaled / (g_fMaxLuminance * g_fMaxLuminance)))) / (1.0 + fLumScaled); ","float ExposureBias = fLumCompressed;","vec3 curr = Uncharted2Tonemap((log2(2.0/pow(luminance,4.0)))*texColor);","vec3 color = curr*whiteScale;","vec3 retColor = pow(color,vec3(1.0/(1.2+(1.2*sunfade))));","gl_FragColor.rgb = retColor;","gl_FragColor.a = 1.0;","}"].join("\n")}),AFRAME.registerShader("gradientshader",{schema:{topColor:{type:"color",default:"1 0 0",is:"uniform"},bottomColor:{type:"color",default:"0 0 1",is:"uniform"}},vertexShader:["varying vec3 vWorldPosition;","void main() {"," vec4 worldPosition = modelMatrix * vec4( position, 1.0 );"," vWorldPosition = worldPosition.xyz;"," gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 bottomColor;","uniform vec3 topColor;","uniform float offset;","varying vec3 vWorldPosition;","void main() {"," float h = normalize( vWorldPosition ).y;"," gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max(h, 0.0 ), 0.8 ), 0.0 ) ), 1.0 );","}"].join("\n")});var r=function(e){var t;this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.p=[];var r;for(r=0;r<256;r++)t=parseFloat("0."+Math.sin(9999*e*r).toString().substr(7)),this.p[r]=Math.floor(256*t);for(this.perm=[],r=0;r<512;r++)this.perm[r]=this.p[255&r]};r.prototype.dot=function(e,t,r,i){return e[0]*t+e[1]*r+e[2]*i},r.prototype.mix=function(e,t,r){return(1-r)*e+r*t},r.prototype.fade=function(e){return e*e*e*(e*(6*e-15)+10)},r.prototype.noise=function(e,t,r){var i=Math.floor(e),o=Math.floor(t),n=Math.floor(r);e-=i,t-=o,r-=n,i&=255,o&=255,n&=255;var s=this.perm[i+this.perm[o+this.perm[n]]]%12,a=this.perm[i+this.perm[o+this.perm[n+1]]]%12,l=this.perm[i+this.perm[o+1+this.perm[n]]]%12,d=this.perm[i+this.perm[o+1+this.perm[n+1]]]%12,h=this.perm[i+1+this.perm[o+this.perm[n]]]%12,g=this.perm[i+1+this.perm[o+this.perm[n+1]]]%12,c=this.perm[i+1+this.perm[o+1+this.perm[n]]]%12,u=this.perm[i+1+this.perm[o+1+this.perm[n+1]]]%12,m=this.dot(this.grad3[s],e,t,r),f=this.dot(this.grad3[h],e-1,t,r),p=this.dot(this.grad3[l],e,t-1,r),y=this.dot(this.grad3[c],e-1,t-1,r),v=this.dot(this.grad3[a],e,t,r-1),C=this.dot(this.grad3[g],e-1,t,r-1),x=this.dot(this.grad3[d],e,t-1,r-1),E=this.dot(this.grad3[u],e-1,t-1,r-1),b=this.fade(e),T=this.fade(t),w=this.fade(r),S=this.mix(m,f,b),A=this.mix(v,C,b),D=this.mix(p,y,b),M=this.mix(x,E,b),R=this.mix(S,D,T),k=this.mix(A,M,T),z=this.mix(R,k,w);return z}}]);
